<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Rocky Smash </title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
  :root{--bg:#02121c;--panel:#0b1f2c;--accent:#1f8bd6;--text:#dff4ff;--gold:#ffcf4d}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif}
  .center{max-width:1000px;margin:18px auto;padding:0 16px}
  #hud{display:flex;gap:12px;align-items:center;justify-content:center;margin-top:10px}
  .pane{background:linear-gradient(180deg,var(--panel),#072026);padding:8px 12px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.5)}
  #gameWrap{display:flex;gap:14px;align-items:flex-start;justify-content:center;margin-top:12px}
  #sidebar{width:300px;display:flex;flex-direction:column;gap:10px}
  canvas{background:#02121c;border-radius:8px;display:block}
  #leaderboard{max-height:260px;overflow:auto;padding-right:6px}
  .muted{color:rgba(223,244,255,0.55);font-size:13px}
  .stat{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:#06262c}
  .selected{outline:2px solid var(--accent);background:rgba(31,139,214,0.06)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;}
  button{background:var(--accent);border:none;color:#fff;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600}
  input,select{padding:8px;border-radius:8px;border:none;background:#062a2f;color:var(--text)}
  #combo{position:fixed;top:18px;left:50%;transform:translateX(-50%);font-size:28px;font-weight:800;color:#42f5ff;pointer-events:none}
  #titleScreen{position:fixed;inset:0;background:linear-gradient(rgba(0,0,0,0.6),rgba(0,0,0,0.6));display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:40}
  #titleScreen h1{font-size:48px;margin:6px;color:var(--accent);letter-spacing:2px}
  .footer{margin-top:12px;color:var(--muted);font-size:13px}
  @media(max-width:900px){ #gameWrap{flex-direction:column;align-items:center} #sidebar{width:100%} }
</style>
</head>
<body>
<div class="center">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h2 style="margin:0">Rocky Smash — Final</h2>
    <div class="muted">Tap ninjas, build combos, beat the leaderboard</div>
  </div>

  <div id="hud">
    <div class="pane stat"><div>Score</div><div id="score">0</div></div>
    <div class="pane stat"><div>Best</div><div id="best">0</div></div>
    <div class="pane stat"><div>Lives</div><div id="lives">3</div></div>
    <div class="pane stat"><div>Combo</div><div id="comboText">x1</div></div>
    <div><button id="startBtn">Start</button></div>
    <div><button id="shareHUD">Share on X</button></div>
  </div>

  <div id="gameWrap">
    <div style="padding:12px;background:linear-gradient(180deg,#021b27,#041018);border-radius:12px" class="pane">
      <canvas id="game" width="900" height="560"></canvas>
      <div class="footer muted">Tap or click the ninjas before they finish their sneak. Rocky appears on the ninja you hit!</div>
    </div>

    <div id="sidebar">
      <div class="pane">
        <div style="font-weight:700;margin-bottom:8px">Leaderboard (Local)</div>
        <div id="leaderboard" class="muted small" tabindex="0" aria-label="Leaderboard"></div>
        <div style="display:flex;gap:6px;margin-top:8px">
          <input id="nameInput" placeholder="Your name" maxlength="12"/>
          <button id="saveScore">Save</button>
        </div>
        <div style="display:flex;gap:6px;margin-top:8px" class="controls">
          <button id="adminToggle">Enter Admin</button>
          <button id="twitterShareSelected">Share Selected</button>
        </div>
        <div style="margin-top:8px" class="muted small">Keyboard: ↑ ↓ to move, Enter to edit, Del to remove (admin).</div>
      </div>

      <div class="pane">
        <div style="font-weight:700;margin-bottom:8px">Options</div>
        <div class="muted small">Sound & vibration, golden ninjas, boss fights, particles enabled.</div>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
          <button id="toggleSound">Sound: On</button>
          <button id="toggleVibe">Vibe: On</button>
        </div>
      </div>

      <div class="pane small muted">
        <div>Share your highscore with <strong>#RockySmash</strong></div>
      </div>
    </div>
  </div>
</div>

<img id="rockyImg" src="rocky_clean3.png" style="display:none"/>

<script>
(() => {
  // Game core (keeps previous features) + Leaderboard controls & Twitter share
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  const scoreEl = document.getElementById('score');
  const bestEl = document.getElementById('best');
  const livesEl = document.getElementById('lives');
  const comboEl = document.getElementById('comboText');
  const startBtn = document.getElementById('startBtn');
  const rockyImg = document.getElementById('rockyImg');

  let score = 0;
  let best = Number(localStorage.getItem('rs_best') || 0);
  let lives = 3;
  let combo = 0;
  let lastHit = 0;
  let running = false;
  let spawnInterval = 900;
  let lastSpawn = 0;
  let ninjas = [];
  let pops = [];
  let particles = [];
  let soundOn = true;
  let vibeOn = true;
  let bossActive = false;
  let boss = null;

  // Leaderboard state
  let leaderboard = JSON.parse(localStorage.getItem('rs_lb') || '[]');
  let selectedIndex = -1;
  let adminMode = false;
  const ADMIN_PASSWORD = localStorage.getItem('rs_admin_pw') || 'jayde'; // default 'admin'

  // Utility
  function rand(min,max){ return Math.random()*(max-min)+min; }
  function vib(ms){ if(vibeOn && navigator.vibrate) navigator.vibrate(ms); }

  // Audio (simple beeps)
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  const audioCtx = AudioCtx ? new AudioCtx() : null;
  function playBeep(freq, type='sine', duration=0.08, vol=0.12){
    if(!audioCtx || !soundOn) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.value = freq;
    g.gain.value = vol;
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime + duration);
  }
  function playHit(){ playBeep(520,'sawtooth',0.06,0.08); playBeep(760,'sine',0.03,0.05); }
  function playCheer(){ playBeep(880,'triangle',0.12,0.12); playBeep(660,'sine',0.09,0.09); }
  function playGameOver(){ playBeep(220,'sawtooth',0.3,0.16); }

  // spawn
  function spawnNinja(){
    const padding = 80;
    let x, y;
    do { x = rand(padding, W - padding); y = rand(padding, H - padding); }
    while (x < 200 && y > H - 160);
    const r = rand(16, 28);
    const timeToFull = rand(1200, 2000);
    const isGolden = Math.random() < 0.04;
    const n = {id:Date.now()+Math.random(), x, y, r, created:Date.now(), timeToFull, hit:false, golden:isGolden, progress:0, hp: isGolden?3:1};
    ninjas.push(n);
  }

  function spawnBoss(){ boss = {x: W/2, y: H/3, r: 60, hp: 10, created:Date.now(), progress:0}; bossActive = true; }

  function drawNinja(n){
    ctx.save(); ctx.translate(n.x, n.y);
    if(n.golden){ ctx.beginPath(); ctx.arc(0,0,n.r+8,0,Math.PI*2); ctx.fillStyle='rgba(255,210,110,0.08)'; ctx.fill(); }
    ctx.beginPath(); ctx.arc(0,0,n.r,0,Math.PI*2); ctx.fillStyle = n.hit ? '#444' : '#0b0b0b'; ctx.fill();
    ctx.fillStyle = n.golden ? 'gold' : '#c62828'; ctx.fillRect(-n.r, -n.r*0.68, n.r*1.8, n.r*0.28);
    ctx.fillStyle = '#fff'; ctx.fillRect(-n.r*0.48, -n.r*0.14, n.r*0.28, n.r*0.12); ctx.fillRect(n.r*0.12, -n.r*0.14, n.r*0.28, n.r*0.12);
    ctx.beginPath(); ctx.lineWidth = 4; ctx.strokeStyle = n.golden ? 'rgba(255,200,80,0.9)' : 'rgba(255,140,60,0.9)';
    const start = -Math.PI/2; const end = start + Math.min(1, n.progress) * Math.PI * 2; ctx.arc(0,0,n.r+10,start,end); ctx.stroke();
    if(n.hp && n.hp>1){ ctx.fillStyle='#fff'; ctx.font='12px system-ui'; ctx.textAlign='center'; ctx.fillText('HP:'+n.hp,0,-n.r-18); }
    ctx.restore();
  }

  function drawBoss(b){ ctx.save(); ctx.translate(b.x,b.y); ctx.beginPath(); ctx.arc(0,0,b.r,0,Math.PI*2); ctx.fillStyle='#2b2b2b'; ctx.fill();
    ctx.fillStyle='rgba(255,0,0,0.9)'; ctx.fillRect(-b.r*0.9,-b.r*0.5,b.r*1.8,12); ctx.fillStyle='#fff'; ctx.font='14px system-ui'; ctx.textAlign='center'; ctx.fillText('BOSS',0,6); ctx.restore(); }

  function createParticles(x,y,color){ for(let i=0;i<18;i++){ particles.push({x,y,vx:rand(-2,2),vy:rand(-3,-0.3),life:rand(30,60),c:color,r:rand(1.5,3.5)}); } }

  // hit handling
  function hitAt(px,py){
    if(bossActive && boss){
      const dx=px-boss.x, dy=py-boss.y;
      if(dx*dx+dy*dy <= boss.r*boss.r){ boss.hp--; playHit(); vib(30); createParticles(px,py,'#ff8a66'); if(boss.hp<=0){ bossActive=false; boss=null; score+=200; playCheer(); } updateHUD(); return; }
    }
    for(let i=ninjas.length-1;i>=0;i--){
      const n=ninjas[i];
      const dx=px-n.x, dy=py-n.y;
      if(dx*dx+dy*dy <= n.r*n.r){
        const perfect = n.progress < 0.18;
        const now = Date.now();
        combo = (now - lastHit < 650) ? combo+1 : 1;
        lastHit = now;
        comboEl.textContent = 'x'+combo;
        document.getElementById('comboText').textContent = 'x'+combo;
        const base = n.golden ? 50 : 10;
        const gained = base * combo * (perfect?2:1) + (n.golden?30:0);
        score += Math.floor(gained);
        createParticles(n.x,n.y, n.golden? 'gold':'#9be7ff');
        playHit();
        if(perfect){ flashPerfect(n.x,n.y); playBeep(1200,'sine',0.08,0.12); }
        if(n.golden) playBeep(1400,'triangle',0.12,0.14);
        vib(25);
        pops.push({x:n.x,y:n.y,t:28});
        setTimeout(()=>{ ninjas.splice(i,1); },90);
        updateHUD();
        return;
      }
    }
  }

  // perfect flash
  let perfectFlash = {t:0,x:0,y:0};

  canvas.addEventListener('pointerdown',(e)=>{ if(!running) return; const rect=canvas.getBoundingClientRect(); const x=(e.clientX-rect.left)*(canvas.width/rect.width); const y=(e.clientY-rect.top)*(canvas.height/rect.height); hitAt(x,y); });

  function updateHUD(){ scoreEl.textContent=score; bestEl.textContent=best; livesEl.textContent=lives; }

  // leaderboard helpers
  function renderLeaderboard(){
    const el = document.getElementById('leaderboard');
    el.innerHTML='';
    leaderboard.forEach((it,idx)=>{
      const row = document.createElement('div');
      row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='6px 8px'; row.style.borderBottom='1px solid rgba(255,255,255,0.03)';
      row.tabIndex = 0;
      row.dataset.index = idx;
      if(idx===selectedIndex) row.classList.add('selected'); else row.classList.remove('selected');
      row.innerHTML = `<div style="color:var(--text)">${idx+1}. ${it.name}</div><div style="color:var(--gold)">${it.score}</div>`;
      row.addEventListener('click', ()=> { selectedIndex = idx; renderLeaderboard(); });
      el.appendChild(row);
    });
  }
  function saveLeaderboard(){ localStorage.setItem('rs_lb', JSON.stringify(leaderboard)); }

  function addScore(name,val){ leaderboard.push({name:name||'Anon',score:val,ts:Date.now()}); leaderboard.sort((a,b)=>b.score-a.score); while(leaderboard.length>50) leaderboard.pop(); saveLeaderboard(); renderLeaderboard(); }

  document.getElementById('saveScore').addEventListener('click', ()=>{
    const name = document.getElementById('nameInput').value || 'Anon';
    addScore(name.substring(0,12), score);
  });

  // keyboard controls for leaderboard
  document.addEventListener('keydown', (e)=>{
    const lbEl = document.getElementById('leaderboard');
    if(document.activeElement === lbEl || adminMode){
      if(e.key === 'ArrowDown'){ selectedIndex = Math.min(leaderboard.length-1, (selectedIndex===-1?0:selectedIndex+1)); renderLeaderboard(); e.preventDefault(); }
      if(e.key === 'ArrowUp'){ selectedIndex = Math.max(0, (selectedIndex===-1?0:selectedIndex-1)); renderLeaderboard(); e.preventDefault(); }
      if(e.key === 'Delete' && adminMode && selectedIndex >=0){ if(confirm('Delete selected score?')){ leaderboard.splice(selectedIndex,1); selectedIndex = -1; saveLeaderboard(); renderLeaderboard(); } }
      if(e.key === 'Enter' && adminMode && selectedIndex >=0){ const it = leaderboard[selectedIndex]; const newName = prompt('Edit name', it.name); const newScore = prompt('Edit score', it.score); if(newName!==null) it.name = newName.substring(0,12); if(newScore!==null) it.score = Number(newScore)||it.score; saveLeaderboard(); renderLeaderboard(); }
    }
  });

  // Admin toggle
  document.getElementById('adminToggle').addEventListener('click', ()=>{
    if(!adminMode){
      const pw = prompt('Enter admin password to enable');
      if(pw === null) return;
      if(pw === ADMIN_PASSWORD){ adminMode = true; alert('Admin mode enabled. Use ↑ ↓ Enter Delete.'); document.getElementById('adminToggle').textContent = 'Exit Admin'; }
      else { alert('Wrong password'); }
    } else { adminMode = false; document.getElementById('adminToggle').textContent = 'Enter Admin'; selectedIndex = -1; renderLeaderboard(); }
  });

  // Share selected on Twitter/X
  document.getElementById('twitterShareSelected').addEventListener('click', ()=>{
    if(selectedIndex < 0 || selectedIndex >= leaderboard.length){ alert('Select a leaderboard entry first'); return; }
    const it = leaderboard[selectedIndex];
    const text = encodeURIComponent(`I beat ${it.name}'s score of ${it.score} on Rocky Smash! #RockySmash`);
    const url = `https://twitter.com/intent/tweet?text=${text}`;
    window.open(url, '_blank');
  });

  // HUD share button
  document.getElementById('shareHUD').addEventListener('click', ()=>{
    const text = encodeURIComponent(`I scored ${score} in Rocky Smash! #RockySmash`);
    window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
  });

  // toggle sound & vibration
  document.getElementById('toggleSound').addEventListener('click', ()=>{ soundOn = !soundOn; document.getElementById('toggleSound').textContent = 'Sound: ' + (soundOn? 'On':'Off'); });
  document.getElementById('toggleVibe').addEventListener('click', ()=>{ vibeOn = !vibeOn; document.getElementById('toggleVibe').textContent = 'Vibe: ' + (vibeOn? 'On':'Off'); });

  // main loop with particles, pops, boss and everything (keeps previous functionality)
  let last = Date.now();
  function loop(){
    const now = Date.now(); const dt = now - last; last = now;
    if(running && now - lastSpawn > spawnInterval){ if(Math.random() < 0.06){ if(!bossActive && Math.random()<0.08){ spawnBoss(); } else { spawnNinja(); } } else spawnNinja(); lastSpawn = now; spawnInterval = Math.max(300, spawnInterval - 1.2); }
    for(let i=ninjas.length-1;i>=0;i--){ const n = ninjas[i]; n.progress = Math.min(1,(now - n.created)/n.timeToFull); if(n.progress >=1 && !n.hit){ ninjas.splice(i,1); lives--; playBeep(220,'sine',0.08,0.08); vib(80); if(lives<=0){ endGame(); return; } } }
    for(let i=particles.length-1;i>=0;i--){ const p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.vy+=0.12; p.life-=1; if(p.life<=0) particles.splice(i,1); }
    ctx.clearRect(0,0,W,H); ctx.fillStyle='#02121c'; ctx.fillRect(0,0,W,H);
    for(let i=0;i<pops.length;i++){ const p=pops[i]; const s=1+(28-p.t)*0.02; const w=rockyImg.naturalWidth*s*0.18; const h=rockyImg.naturalHeight*s*0.18; ctx.save(); ctx.globalAlpha=Math.max(0.2,p.t/28); ctx.drawImage(rockyImg,p.x-w/2,p.y-h/2,w,h); ctx.restore(); p.t--; if(p.t<=0) pops.splice(i,1); }
    ninjas.forEach(n=>drawNinja(n)); if(bossActive && boss) drawBoss(boss);
    particles.forEach(p=>{ ctx.beginPath(); ctx.fillStyle=p.c; ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); });
    if(perfectFlash.t>0){ ctx.save(); ctx.globalAlpha = perfectFlash.t/18; ctx.fillStyle='rgba(255,255,255,0.06)'; ctx.fillRect(0,0,W,H); ctx.restore(); perfectFlash.t--; }
    requestAnimationFrame(loop);
  }

  function start(){
    score = 0; lives = 3; combo = 0; lastHit = 0; running = true; spawnInterval = 900; lastSpawn = 0; ninjas = []; pops=[]; particles=[]; bossActive=false; boss=null; updateHUD();
  }
  function endGame(){
    running=false;
    playGameOver();
    if(score>best){
      best=score;
      localStorage.setItem('rs_best',best);
    }
    updateHUD();
    setTimeout(()=>{
      const want = confirm('Game over! Save your score to the leaderboard?');
      if(want){
        const name = prompt('Enter your name (max 12 chars)') || 'Anon';
        addScore(name.substring(0,12), score);
      }
      start();
    },200);
  }
  // save/load leaderboard on start
  leaderboard = JSON.parse(localStorage.getItem('rs_lb') || '[]');
  renderLeaderboard();

  // UI bindings
  document.getElementById('startBtn').addEventListener('click', ()=>{ start(); document.getElementById('titleScreen')?.remove(); });
  document.getElementById('saveScore').addEventListener('click', ()=>{ const name=document.getElementById('nameInput').value||'Anon'; addScore(name.substring(0,12), score); });
  document.getElementById('twitterShareSelected').addEventListener('click', ()=>{ if(selectedIndex<0||selectedIndex>=leaderboard.length){ alert('Select an entry first'); return;} const it=leaderboard[selectedIndex]; window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(`I beat ${it.name}'s score of ${it.score} on Rocky Smash! #RockySmash`),'_blank'); });
  document.getElementById('shareHUD').addEventListener('click', ()=>{ window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(`I scored ${score} in Rocky Smash! #RockySmash`),'_blank'); });

  // attach admin password change option (keeps safe locally)
  document.getElementById('adminToggle').addEventListener('dblclick', ()=>{ const newpw = prompt('Set admin password (leave blank to keep)'); if(newpw){ localStorage.setItem('rs_admin_pw', newpw); alert('Admin password updated locally. Use Enter Admin and input the password.'); } });

  // initial values
  best = Number(localStorage.getItem('rs_best') || 0);
  bestEl.textContent = best;
  document.getElementById('toggleSound').textContent = 'Sound: On';
  document.getElementById('toggleVibe').textContent = 'Vibe: On';

  window.addEventListener('keydown',(e)=>{
    if(!running && e.code==='Space'){ start(); return; } if(e.code==='Space' && !running){ start(); document.getElementById('titleScreen')?.remove(); } });

  // perfect flash function
  function flashPerfect(x,y){ perfectFlash = {t:18,x,y}; createParticles(x,y,'#fff'); }

  // start loop
  loop();

})();
</script>

</body>
</html>
